version: 2.0

workflows:
   version: 2
   build-and-test:
      jobs:
         - build
         - test:
            requires:
               - build

jobs:
   build:
      docker:
         - image: luadevkit/buildpack-deps:luarocks
      environment:
         LUA: lua5.3
      steps:
         - checkout
         - run:
              name: Build module
              command: make build
         - persist_to_workspace:
              root: /lua
              paths:
                 - lib/lua/5.3/ldk
   test:
      docker:
         - image: luadevkit/buildpack-deps:busted
      environment:
         LUA: lua5.3
      steps:
         - checkout
         - attach_workspace:
              at: /lua
         - run:
              name: Run tests
              command: |
                 mkdir -p /tmp/test-reports
                 busted -o junit -Xoutput /tmp/test-reports/result.xml
         - store_test_results:
              path: /tmp/test-reports
